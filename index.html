<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.min.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <script>
      function createDivider ( text ) {
        var divider = document.createElement('div')
        divider.className = 'divider'
        divider.innerHTML = text
        document.getElementById('calculation-container').appendChild(divider)
      }
      function createColumns ( columns ) {
        for ( let i = 0; i < columns.length; i++ ) {
          const column = document.createElement('textarea')
          column.className = 'column' + columns.length
          column.innerHTML = columns[i]
          document.getElementById('calculation-container').appendChild(column)
        }
      }

      async function loadFile ( event ) {
        const file = event.target.files.item(0)
        const contents = await file.text()
        document.getElementById('input').value = contents
      }
      function decryptIdleSpiral ( ) {
        const input = document.getElementById('input').value

        // Split on #
        createDivider("Split on #")
        const split = input.split('#')
        createColumns(split)

        // Parse Base64
        createDivider("Parse Base64")
        const base64 = split.map( (x) => CryptoJS.enc.Base64.parse(x) )
        createColumns(base64)

        // Decrypt AES-CBC
        createDivider("Decrypt AES-CBC (0901f87d5725efde4e4ae88cc197230b, 14ce63b855acd907c451a1777e592457)")
        var key = CryptoJS.enc.Hex.parse("0901f87d5725efde4e4ae88cc197230b")
        var iv = CryptoJS.enc.Hex.parse("14ce63b855acd907c451a1777e592457")
        const aes = base64.map( (x) => CryptoJS.AES.decrypt({ ciphertext: x }, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 }) )
        createColumns(aes)

        // Format as UTF-8
        createDivider("Format as UTF-8")
        const utf8 = aes.map( (x) => x.toString(CryptoJS.enc.Utf8) )
        createColumns(utf8)
      }
      function decryptIncrementalAdventures ( ) {
        const input = document.getElementById('input').value

        // AES "gwFgN"
        createDivider("AES \"gwFgN\"")
        const aes = CryptoJS.AES.decrypt(input, "gwFgN")
        createColumns([aes])

        // Format as UTF-8
        createDivider("Format as UTF-8")
        const utf8 = aes.toString(CryptoJS.enc.Utf8)
        createColumns([utf8])
      }
      function decryptFile ( ) {
        const option = document.getElementById('option').value
        document.getElementById('calculation-container').innerHTML = ''
        if ( option === 'idlespiral' )
          decryptIdleSpiral()
        if ( option === 'incrementaladventures' )
          decryptIncrementalAdventures()
      }
    </script>
  </head>
  <body>
    <div>
      <div id="main">
        <div id="header">
          <input type="file" onchange="loadFile(event)"/><br/>
          <select id="option">
            <option value="idlespiral">Idle Spiral</option>
            <option value="incrementaladventures">Incremental Adventures</option>
          </select>
          <input type="button" value="Decrypt" onclick="decryptFile()"/><br/>
        </div>
        <div id="editor">
          <div id="input-container">
            <div class="divider">Input</div>
            <textarea id="input" class="column1"></textarea>
          </div>
          <div id="calculation-container">

          </div>
        </div>
        <div id="footer">

        </div>
      </div>
    </div>
  </body>
</html>
